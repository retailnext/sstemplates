package com.sivoh.hssftemplates.servlet;

import com.meterware.httpunit.*;
import com.meterware.servletunit.*;
import com.sivoh.hssftemplates.*;
import com.sivoh.hssftemplates.tags.*;
import junit.framework.*;

import javax.servlet.*;
import java.io.*;
import java.util.*;

/**
 * 
 * @author sivoh
 * @version $REVISION
 */
public abstract class HssfTemplateServletBaseTest extends TestCase
{
  private static ServletRunner servletRunner = null;

  public HssfTemplateServletBaseTest(String s)
  {
    super(s);
  }

  protected void setUp() throws Exception
  {
    if ( servletRunner == null )
    {
      File file = new File("c:/dev/entreevous/build/hssftest/WEB-INF/hssf-web.xml");
      servletRunner = new ServletRunner(file, "");
    }
  }

  protected void tearDown() throws Exception
  {
  }

  protected String getPathFromServlet(InvocationContext context) throws Exception
  {
    return ((HssfTemplateServlet) context.getServlet()).pathFromRequestURL(context.getRequest()).toString();
  }

  protected HssfTemplateServletContext getHssfTemplateContext(InvocationContext invocationContext) throws ServletException
  {
    return ((HssfTemplateServlet) invocationContext.getServlet()).createTemplateContext(invocationContext.getRequest());
  }

  protected HssfWorkbookTag getRenderTree(InvocationContext context) throws Exception
  {
    return getServlet(context).getProcessor().retrieveRenderTree(getPathFromServlet(context));
  }

  protected HssfTemplateServlet getServlet(InvocationContext context) throws ServletException
  {
    return ((HssfTemplateServlet) context.getServlet());
  }

  protected InvocationContext getTestInvocation() throws Exception
  {
    return getTestInvocation("test.hssft");
  }

  protected InvocationContext getTestInvocation(String fileName) throws Exception
  {
    ServletUnitClient sc = servletRunner.newClient();
    WebRequest request = getWebRequest(fileName);
    InvocationContext context = sc.newInvocation( request );
    assertNotNull( "No response received", context );
    assertNotNull( "No servlet received", context.getServlet() );
    return context;
  }

  protected WebResponse getResponse( String filename )
    throws Exception
  {
    ServletUnitClient sc = servletRunner.newClient();
    return sc.getResponse(getWebRequest(filename));
  }

  private WebRequest getWebRequest(String fileName)
  {
    return (WebRequest) new PostMethodWebRequest( "http://test.sivoh.com/hssf/" + fileName );
  }

  protected HssfTemplateContext renderWorkbook(InvocationContext context) throws Exception
  {
    return renderWorkbook(context, null);
  }

  protected HssfTemplateContext renderWorkbook(InvocationContext context, Map attributes)
          throws Exception
  {
    HssfWorkbookTag renderTree = getRenderTree(context);
    HssfTemplateServletContext templateContext = getHssfTemplateContext(context);
    if ( attributes != null )
    {
      for (Iterator it = attributes.keySet().iterator(); it.hasNext();)
      {
        String key = (String) it.next();
        templateContext.getRequest().setAttribute(key,attributes.get(key));
      }
    }
    renderTree.render(templateContext);
    return templateContext;
  }


}
