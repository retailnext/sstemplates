<html>
<head>
<link rel="stylesheet" type="text/css" href="../../../../properties/javadoc.css" title="style">
</head>
<body>
ASTranslator provides JavaBean-style mapping between Java objects in any J2EE application server and ActionScript objects in Flash MX when used with Macromedia Flash Remoting MX.

<h2><a name="documentation">ASTranslator For Macromedia Flash Remoting MX</a></h2>

ASTranslator is designed to be used with <a target="_top" href="http://www.macromedia.com/software/flashremoting/">Macromedia Flash Remoting MX</a> on any J2EE application server. It provides JavaBean-style mapping between Java objects in the application server and ActionScript objects in Flash MX. More information on why this is so important, <a href="#overview">read the overview</a>.

<p>
ASTranslator is supported by <a target="_top" href="http://www.carbonfive.com/">Carbon Five</a> and can be deployed on application servers with Flash Remoting MX including Macromedia JRun, Jakarta Tomcat, JBoss, Caucho Resin, IBM WebSphere, BEA Weblogic and ATG Dynamo.

<ul>
<li><a href="#overview">Overview</a>
<li><a href="#features">Features</a>
<li><a href="#download">Download</a>
<li><a href="#prerequisites">Prerequisites</a>
<li><a href="#install">Install</a>
<li><a href="#usage">Usage</a>
<li><a href="#errors">Error Handling</a>
<li><a href="#databinding">Data Binding</a>
<li><a href="#issues">Known Issues</a>
<li><a href="#support">Support</a>
<li><a href="#developers">Developers</a>
<li><a href="#reference">Reference</a>
<li><a href="#credits">Credits</a>
</ul>

<hr size="1">

<h3><a name="overview">Overview</a></h3>

ASTranslator provides the ability to translate between ASObjects used by Macromedia Flash Remoting and Java objects in your application. ASObjects are essentially HashMaps where the key values are case insensitive and with an additional field "type". ASObjects are a Java representation of ActionScript objects in Flash.

<p>
We created ASTranslator because of an issue we found with Flash Remoting MX for J2EE. When returning Java objects from service calls to Flash, Flash Remoting serializes Java objects according to their private member state, not using it's publicly declared property accessors as you would expect. So if you have a Java class:

<pre class="code">
package com.server;

public class Player
{
  private String _name;
  
  public getName()
  {
    return _name;
  }
}
</pre>

and a service class:

<pre class="code">
package com.server;

public class Service
{
  public Player getPlayer(String name)
  {
    Player player = Roster.getPlayer(name);
    return player;
  }
}
</pre>

calling Service.getPlayer() from Flash MX would return an ActionScript object with a property "_name" instead of "name." This removes one of the primary values of object oriented programming: <i>encapsulation</i>. ActionScript programmers in Flash can see the internal state of Java objects on the server that even other Java objects running on the server cannot see. This is bad. It can be really bad (both for performance and security) if the internal state includes a lot more information than the object was designed to expose through its public interface.

ASTranslator adds the behavior of using JavaBean-style introspection to serialize Java objects for Remoting. To use ASTranslator in the above example, we would change the Service class as follows:

<pre class="code">
package com.server;

import flashgateway.io.ASObject;
import com.carbonfive.flash.ASTranslator;
  
public class Service
{
  public ASObject getPlayer(String name)
  {
    Player player = Roster.getPlayer(name);
    ASObject aso = (ASObject) new ASTranslator().toActionScript(player);
    return aso;
  }
}
</pre>

Flash will now receive an ActionScript object with the property "name."

<h3><a name="features">Features</a></h3>

<h4>JavaBean-Style Serialization From Java to ActionScript</h4>

As described in the <a href="#overview">overview</a>, ASTranslator enhances Flash Remoting by adding the ability to send Java objects to Flash using the Java object properties as defined by the object's property accessors (getters and setters) rather than using the object's internal member state as Remoting does by default.
<p>
ASTranslator follows the <a target="_top" href="http://livedocs.macromedia.com/frdocs/Using_Flash_Remoting_MX/UseASData4.jsp">conversion rules for Flash Remoting for J2EE</a> and relies on the remoting gateway to handle conversion of class types named by the conversion rules. Additionally, if it does not know what to do with an object type, it simply passes it through. Therefore it is safe to pass all objects through ASTranslator.toActionScript() when sending them back to Flash. This is the recommended use.
<p>
The Java programmer can identify classes, interfaces or specific properties of objects that should not be translated to ActionScript in a call to ASTranslator.toActionScript().  This is done through the use of ASTranslator.ignoreClass() and ASTranslator.ignoreProperty().  This is useful when you wish to reduce network traffic by not sending irrelevant data to Flash.  Specific information on this is provided in the <a href="#usage">usage documentation</a>.
<p>
ASTranslator also identifies potential loops while translating from a JavaBean to an ActionScript object.
<p>
Additionally, if the ActionScript programmer has registered ActionScript objects using Object.registerClass() that map directly to Java objects, the objects returned as the result of a Remoting service call will be of that registered type when returned to the service XXXX_onResult() callback method. More information on this is provided in the <a href="#usage">usage documentation</a>.

<h4>JavaBean-Style Deserialization From ActionScript to Java</h4>

When sending ActionScript objects to the server through Flash Remoting service method calls, the Java service class will either receive one of the known Java object types or an ASObject if the object type is not known. The process of converting these ASObjects to model objects in the application server can be tedious and brittle. ASTranslator adds automatic conversion of ASObjects to Java objects using JavaBean-style introspection to set the Java object properties.
<p>
With Flash Remoting alone, calling a service method with an object argument from Flash would look like:

<pre class="code">
#include "NetServices.as"

NetServices.setDefaultGatewayUrl("http://localhost/gateway");
var gatewayConnection = NetServices.createGatewayConnection();
var service = gatewayConnection.getService("Service", this);

Player = function() {}

var player = new Player();
player.name = "Joe";

service.savePlayer(player);
</pre>

and the Java service class would look like:

<pre class="code">
package com.server;

import flashgateway.io.ASObject;
  
public class Service
{
  public void savePlayer(ASObject asPlayer)
  {
    Player player = new Player();
    player.setName((String) asPlayer.get("name"));
    
    Roster.savePlayer(player);
  }
}
</pre>

With ASTranslator, the ActionScript would look like:

<pre class="code">
#include "NetServices.as"

NetServices.setDefaultGatewayUrl("http://localhost/gateway");
var gatewayConnection = NetServices.createGatewayConnection();
var service = gatewayConnection.getService("Service", this);

Player = function() {}
Object.registerClass("com.server.Player", Player);

var player = new Player();
player.name = "Joe";

service.savePlayer(player);
</pre>

and the service class would look like:

<pre class="code">
import flashgateway.io.ASObject;
import com.carbonfive.flash.ASTranslator;
  
public class Service
{
  public void savePlayer(ASObject asPlayer)
  {
    Player player = (Player) new ASTranslator().fromActionScript(asPlayer);
    
    Roster.savePlayer(player);
  }
}
</pre>

ASTranslator will create and set as many properties in the Java Player object as match in the ASObject received from Flash.
<p>
In order for ASTranslator to know what Java object type to convert the ASObject to, the type field of the ASObject must be set to the class name of the desired Java object type. This is achieved by using Object.registerClass() in ActionScript to associate the ActionScript object type with the Java class. More information on this is provided in the <a href="#usage">usage documentation</a>.

<h3><a name="download">Download</a></h3>

The latest release of ASTranslator is available for download from <a target="_top"  href="http://sourceforge.net/project/showfiles.php?group_id=52145">SourceForge.net</a>. For the adventurous, you can check out the <a target="_top" href="http://sourceforge.net/cvs/?group_id=52145">latest changes from CVS</a>.

<h3><a name="prerequisites">Prerequisites</a></h3>

To use ASTranslator effectively, you must first have <a target="_top"  href="http://www.macromedia.com/software/flashremoting/downloads/">Flash Remoting for J2EE</a> installed in your application server and the <a target="_top"  href="http://www.macromedia.com/software/flashremoting/downloads/components/">Flash Remoting Components</a> installed in your Flash MX authoring environment. 
<p>
While <a target="_top"  href="http://www.macromedia.com/support/flash_remoting/ts/documents/presalesfaq.htm#javafiles">Macromedia is somewhat vague on the issue</a> we <b>strongly</b> recommend installing Flash Remoting for your application by:
<ol>
<li>locating flashgateway.jar in the flashgateway.ear or flashgateway.war file installed by the Macromedia installer
<li>placing it in your web application's WEB-INF/lib/ directory
<li>mapping the gateway for your web application by adding the following to your web application's WEB-INF/web.xml file:

<pre class="code">
  &lt;servlet>
    &lt;servlet-name>FlashGatewayServlet&lt;/servlet-name>
    &lt;display-name>Flash Remoting Servlet&lt;/display-name>
    &lt;description>Servlet-based plugin to Flash Remoting&lt;/description>
    &lt;servlet-class>flashgateway.controller.GatewayServlet&lt;/servlet-class>
    &lt;load-on-startup>10&lt;/load-on-startup>
  &lt;/servlet>

  &lt;servlet-mapping>
    &lt;servlet-name>FlashGatewayServlet&lt;/servlet-name>
    &lt;url-pattern>/gateway&lt;/url-pattern>
  &lt;/servlet-mapping>
</pre>
</ol>

This will make the Remoting Gateway Service available at http://www.yourdomain.com/yourwebapp/gateway and all classes in your application visible to Flash Remoting.
<p>
ASTranslator also utilizes specific components from the Jakarta Commons project.  These libraries are provided in the distribution, and can be freely used by commercial and non-commercial applications.  More information can be found here:
<ul>
<li>Jakarta Commons BeanUtils - <a target="_top" href="http://jakarta.apache.org/commons/beanutils.html">home page</a>
<li>Jakarta Commons Collections - <a target="_top" href="http://jakarta.apache.org/commons/collections.html">home page</a>
<li>Jakarta Commons Logging - <a target="_top" href="http://jakarta.apache.org/commons/logging.html">home page</a>
</ul>

<h3><a name="install">Install</a></h3>

To install ASTranslator, first install Flash Remoting for J2EE MX as recommended in <a href="#prerequisites">prerequisites</a>.  You must then unzip astranslator-x.x.zip and copy the following jars to your web application's WEB-INF/lib/ directory:
<ul>
<li>lib/astranslator-x.x.jar
<li>lib/commons-beanutils.jar
<li>lib/commons-collections.jar
<li>lib/commons-logging.jar
</ul>
<p>
If you have installed Flash Remoting MX for J2EE in another manner, the best location for astranslator-x.x.jar will depend on the application server you are using. Here you get in to the sticky world of class loader precedence. Better to keep it all in your webapp.

<h3><a name="usage">Usage</a></h3>

<a href="ASTranslator.html">ASTranslator</a> is the only class you will use in Java. 

<h4>From Flash to Java</h4>

Use <a href="ASTranslator.html#fromActionScript(java.lang.Object)">ASTranslator.fromActionScript()</a> to translate ASObjects sent to remoting service methods from Flash. 

<pre class="code">
import flashgateway.io.ASObject;
import com.carbonfive.flash.ASTranslator;
  
public class Service
{
  public void savePlayer(ASObject asPlayer)
  {
    Player player = (Player) new ASTranslator().fromActionScript(asPlayer);
    
    Roster.savePlayer(player);
  }
}
</pre>

Note that you must cast the result of this method call to the expected return type. fromActionScript() can take any object as an argument. It will translate any object and it's composite objects as deep as possible.
<p>
In order for ASTranslator to know what Java class an ASObject should become, you must register your ActionScript objects in Flash MX with the Java class name that the ActionScript object maps to.

<pre class="code">
Player = function() {}                              // Object definition
Object.registerClass("com.server.Player", Player);  // Player maps to com.server.Player in Java
</pre>

<h4>From Java to Flash</h4>

Use <a href="ASTranslator.html#toActionScript(java.lang.Object)">ASTranslator.toActionScript()</a> to translate Java objects to ASObjects before sending them back to flash as the result of a Flash Remoting service call.

<pre class="code">
package com.server;

import flashgateway.io.ASObject;
import com.carbonfive.flash.ASTranslator;
  
public class Service
{
  public ASObject getPlayer(String name)
  {
    Player player = Roster.getPlayer(name);
    ASObject aso = (ASObject) new ASTranslator().toActionScript(player);
    return aso;
  }
}
</pre>

Be aware that your custom Java object, eg: Player, <b>must implement Serializable</b> in order for ASTranslator to property convert them to Action Script objects.
<p>
Note that you must cast the result of this method call to the expected return type. It will either be an ASObject, a Java Collection or one of the Java Class types known to Flash Remoting (XML Document, ResultSet,...).
<p>
If you wish to specify classes or interfaces to be left out of the translation, the code can look like this:

<pre class="code">
package com.server;

import flashgateway.io.ASObject;
import com.carbonfive.flash.ASTranslator;
  
public class Service
{
  public ASObject getPlayer(String name)
  {
    Player player = Roster.getPlayer(name);
    ASTranslator translator = new ASTranslator();
    translator.ignoreClass("com.yourcompany.Address");
    translator.ignoreProperty("com.yourcompany.Player", "email");

    ASObject aso = (ASObject) translator.toActionScript(player);
    return aso;
  }
}
</pre>

This would cause ASTranslator to ignore any object of type com.yourcompany.Address while translating, as well as the getEmail() property of the com.yourcompany.Player class itself.
<p>

For Java object that are not known to Flash Remoting, ASTranslator will set the "type" field of the resulting ASObject to be the class name of the translated Java object. If you register your ActionScript objects to map to Java objects as detailed in the section above, the ActionScript objects that are returned to Flash will be of the correct ActionScript object type.

<pre class="code">
#include "NetServices.as"

NetServices.setDefaultGatewayUrl("http://localhost/gateway");
var gatewayConnection = NetServices.createGatewayConnection();
var service = gatewayConnection.getService("Service", this);

// Define Player
Player = function() {}

// Define Player methods
Player.prototype.getName = function()
{
  return name;
}

// Register Player object to map to com.server.Player Java object
Object.registerClass("com.server.Player", Player);

// Get Player from Flash Remoting
service.getPlayer("Joe");

// Handle Flash Remoting result
getPlayer_Result(player)
{
  // player is an ActionScript object of type Player
  var name = player.getName();
}
</pre>

<h4>Recommended Usage</h4>

Flash Remoting MX provides features that we feel confuse it's best use. Yes, you can communicate directly with Session and Entity EJBs, JSPs and Servlets, and have object state persisted in the user session but just because you can does not mean you should. Here are our recommendations for using Flash Remoting to build easy to integrate and scalable Rich Internet Applications:

<ul>
<li>Install Flash Remoting MX and ASTranslator as recommended in the <a href="#install">installation instructions<a>.
<li>Create an interface to your server-side application using a Service Oriented Architecture
  <ul>
  <li>Create one or more objects in your web application that expose stateless services to Flash through Flash Remoting
  <li>Do not make these service objects Serializable or a new instance will be stored in each user's session
  <li>These objects will have method signatures that take and return ASObjects and the other types known to Flash Remoting
  <li>These objects will be the only place where you use ASTranslator to map ASObjects to your Java objects
  </ul>
<li>Create a client-side Service object that handles all communication with the Remoting service including creating the initial connection. This Service object is basically a client-side Proxy to the Remoting services.
<li>Create client-side model objects that map to model objects in Java and use Object.registerClass() to map them to the appropriate Java class
</ul>

Using Flash Remoting in this manner to support a Service Oriented Architecture is a good idea. It creates a well-defined point of integration between the Flash client application and the J2EE server application. It exposes your J2EE application a set of services that can easily be made available to other client platforms through Web Services or to a local JSP/Servlets implementation.

<h3><a name="errors">Error Handling</a></h3>

In a Flash MX client to a Remoting service, you handle the results of a remoting call (e.g. service.doCall()) by implementing a doCall_onResult callback method for service calls that execute successfully and an doCall_onStatus callback method for exceptions thrown by the Remoting gateway. The Remoting gateway will throw exceptions when:
<ul>
<li>it encounters problems locating, loading, or creating the service class and the method to invoke on it
<li>the service class itself throws an exception
</ul>

Given this behavior and our recommendation to use a service-oriented architecture with Flash Remoting, we recommend having the service implementation throw exceptions to be handled by the Flash MX client. In the simplest case we recommend having all service methods simply throw Exception.

<pre class="code">
package com.server;

import flashgateway.io.ASObject;
import com.carbonfive.flash.ASTranslator;
  
public class Service
{
  public ASObject getPlayer(String name)
    throws Exception
  {
    Player player = Roster.getPlayer(name);
    ASObject aso = (ASObject) new ASTranslator().toActionScript(player);
    return aso;
  }
}
</pre>

This would allow the Flash MX client to inspect all exceptions thrown during the service invocation and determine what to do about it at runtime. This strategy is discussed in the Flash Remoting documentation at <a target="_new" href="http://livedocs.macromedia.com/frdocs/Using_Flash_Remoting_MX/UseActionScript8.jsp">http://livedocs.macromedia.com/frdocs/Using_Flash_Remoting_MX/UseActionScript8.jsp</a>.
<p>
The "type" field of the error object returned to getPlayer_onStatus should provide the class name of the thrown exception allowing us to implement the callback in Flash as:

<pre class="code">
getPlayer_onStatus = function (error)
{
  if (error.type == "com.server.PlayerNotFoundException")
  {
    trace("unable to find the player");
  }
  else
  {
    trace("an unknown error occurred");
  }
}
</pre>

One limitation to this approach is that inheritance is not taken in to account. A thrown exception that extends com.server.PlayerNotFoundException is a com.server.PlayerNotFoundException but would not be handled as one in the above ActionScript code.
<p>
A more significant limitation to this approach is that Flash Remoting MX for J2EE does not actually send exceptions thrown by a service class to the XXX_onStatus callback method. Because the Flash Remoting gateway uses introspection to invoke the service methods, all exceptions thrown by service calls are nested within a java.lang.reflect.InvocationTargetException. Tracing the properties of an exception thrown by a service call results in output that looks something like:

<pre class="code">
 code:        SERVER.PROCESSING
 level:       error
 description: Service threw an exception during method invocation: null
 type: java.lang.reflect.InvocationTargetException
 rootcause: 
 details:     java.lang.reflect.InvocationTargetException
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	...
	at flashgateway.Gateway.invoke(Gateway.java:184)
	...
	at java.lang.Thread.run(Thread.java:536)
Caused by: com.server.PlayerNotFoundException: There is no player with name 'bob'
	at com.server.Roster.getPlayer(Roster.java:45)
	...
</pre>

We would like the nested com.server.PlayerNotFoundException to be used as exception upon which the error object is based but it is not. We have not come up with a great solution to this problem. 

<p>
The best solution we have come up with is to build a new error object that inspects the "detail" field of the error returned by Remoting to determine the correct values for "description," "type" and "details." Unfortunately the formatting of the stack trace as provided by the "details" field differs depending on the JVM version being used on the server. Specifically, between Java 1.3 and Java 1.4 the way in which nested exceptions are printed in a stack trace is different. This makes inspecting the "detail" field brittle and a source of hard-to-uncover bugs.

<p>
Please let us know if you have recommendations for dealing with this issue.

<h3><a name="databinding">Data Binding</a></h3>

There's been some discussion of binding more than just RecordSets to UI components using DataGlue. This makes a ton of sense, especially since we typically think of collections of business objects instead of database recordsets - a mindset that ASTranslator is designed for. Here's a simple start that binds any array of objects to a UI component using DataGlue. A handy use of this would be to take an array result received from remoting and bind it to a UI component just as you would a RecordSet.
 <p>
Here's an implementation of an ArrayDataProvider that provides a DataProvider view of an array. You can use objects of this class to bind to UI components with DataGlue.

<pre class="code">
/**
 * ArrayDataProvider.as
 * Alon Salant, Carbon Five
 *
 * ArrayDataProvider implements a DataProvider view of an array
 * so that it can be bound to UI components using DataGlue.
 */
 
#include "RsDataProviderClass.as"

_global.ArrayDataProvider = function(list)
{
  this.init();
  this.addAll(list);
}

ArrayDataProvider.prototype = new RsDataProviderClass();

ArrayDataProvider.prototype.addAll = function(list)
{
  if (list != null && list.length > 0)
  {
    for (var i = 0; i < list.length; i++)
    {
    	this.addItem(list[i]);	
    }
  }
}

ArrayDataProvider.prototype.checkLocal = function()
{
  return true;
}
</pre>


Here's the code from a sample fla that has a list box UI component
with instance name lb_people. 

<pre class="code">
#include "DataGlue.as"
#include "ArrayDataProvider.as"

Person = function(firstName, lastName)
{
  this.firstName = firstName;
  this.lastName = lastName;
}

var people = new Array();
people.push(new Person("Mike", "Wynholds"));
people.push(new Person("Sam", "Borgenson"));
people.push(new Person("Don", "Thompson"));
people.push(new Person("Alon", "Salant"));

var dataprovider = new ArrayDataProvider(people);

DataGlue.BindFormatStrings(lb_people, dataprovider, "#firstName# #lastName#", "#firstName#-#lastName#");
</pre>

The last two lines you would put in a remoting XXX_Result method to
bind remoting results to a UI component.

<h3><a name="issues">Known Issues</a></h3>

In our work with Flash Remoting MX for J2EE we have encountered the following issues:

<h4>Remoting Exposes Private State of Server-side Objects</h4>

This issue is discussed in the <a href="#overview">Overview</a> and was the primary motivation for developing ASTranslator.

<h4>Exceptions Hidden by java.lang.reflect.InvocationTargetException</h4>

Exceptions thrown by the J2EE implementation of a Remoting service are nested by java.lang.reflect.InvocationTargetException and are not exposed to the Flash MX client in a usable way. This is discussed in <a href="#errors">Error Handling</a>.

<h3><a name="support">Support</a></h3>

For support, please read and post to the <a target="_top"  href="http://sourceforge.net/forum/forum.php?forum_id=191315">forums on SourceForge.net</a>.

<h3><a name="developers">Developers</a></h3>

For those interesting in peeking under the hood or making changes, the <a href="#download">distribution</a> includes the source code, an Ant build script and JUnit unit tests that can be used to make changes. Simply unzip/unjar the distribution to get started.

<h3><a name="reference">Reference</a></h3>

<ul>
<li> <a href="http://www.onjava.com/pub/a/onjava/2003/02/26/flash_remoting.html">Flash Remoting for J2EE Developers</a><br/>
     O'Reilly onJava.com article by project contributor Alon J Salant.</li>

<li> <a href="http://www.iterationtwo.com/realityj2ee/">Reality J2EE</a><br/>
     Book by project contributor Steven Webster features ASTranslator. <br/>
     Note <a href="http://www.iterationtwo.com/realityj2ee/errata.jsp">the clarification of it's discussion of ASTranslator</a>.</li>

<li> <a href="http://www.macromedia.com/software/flashremoting/">Flash Remoting MX Homepage</a><br/>
     Macromedia resource.</li>

<li> <a href="http://www.macromedia.com/software/flashremoting/downloads/components/">Download Flash MX Remoting Components</a><br/>
     Macromedia resource.</li>

<li> <a href="http://www.macromedia.com/software/trial_download/">Download Flash Remoting MX</a><br/>
     Macromedia resource.</li>

<li> <a href="http://www.macromedia.com/desdev/mx/blackboard/articles/flash_remoting_design_2.0.html">Flash Remoting 101 for Java Users</a><br/>
     Macromedia resource.</li>

<li> <a href="http://www.macromedia.com/software/flashremoting/whitepapers/pdf/flr_j2ee.pdf">A Technical Overview of Flash Remoting MX for Java Developers</a> (PDF)<br/>
     Macromedia resource.</li>

<li> <a href="http://www.macromedia.com/support/flash_remoting/ts/documents/presalesfaq.htm">Common Questions About Flash Remoting</a><br/>
     Macromedia resource.</li>

<li> <a href="http://www.macromedia.com/support/flash_remoting/ts/documents/presalesfaq.htm#jrunrestriction">Modifying Java Security Policy for Remoting</a><br/>
     Macromedia resource.</li>

</ul>

<h3><a name="credits">Credits</a></h3>

Alon J Salant, <a href="http://www.carbonfive.com">Carbon Five</a><br>
Mike Wynholds, <a href="http://www.carbonfive.com">Carbon Five</a><br>
Steven Webster, <a href="http://www.iterationtwo.co.uk">iteration::two</a><br>

</body>
</html>